# カスタムバッジ機能 要件定義

最終更新日: 2025-08-07

## 概要

ユーザーが独自のバッジを作成・管理し、POPに適用できる機能を提供する。従来の固定バッジ（RECOMMEND、MUST、RAVE、ACID）を完全に置き換え、より柔軟で個性的なPOPデザインを実現する。

## 主要機能

### 1. カスタムバッジ作成・管理

#### 1.1 バッジタイプ
- **テキストバッジ**: 円形の背景に文字を表示
- **画像バッジ**: ユーザーがアップロードした画像を表示（将来対応）

#### 1.2 制限・制約
- **最大作成数**: 5個まで
- **バッジ名**: 最大20文字
- **表示テキスト**: 最大10文字（目安、円内に収まるように）
- **データ保存**: LocalStorage（将来的にサーバー対応予定）

#### 1.3 テキストバッジの設定項目
- **バッジ名**: 管理用の名前（「おすすめ」「新入荷」など）
- **表示テキスト**: 実際にバッジに表示される文字
- **背景色**: カラーピッカーで選択（デフォルト: #3b82f6）
- **文字色**: カラーピッカーで選択（デフォルト: #ffffff）
- **フォントサイズ**: 8px〜24pxのスライダー（デフォルト: 12px）
- **フォントファミリー**: Arialで固定（visual-editor統一設定と連携）
- **枠線設定**:
  - **枠線の有無**: ON/OFF切り替え（デフォルト: ON）
  - **枠線の色**: カラーピッカーで選択（デフォルト: #ffffff 白）
  - **枠線の太さ**: 0.5mm〜3mmのスライダー（デフォルト: 1mm）

#### 1.4 形状・サイズ
- **形状選択**: 
  - **Circle**: 円形（縦横サイズが違えば楕円）
  - **Rectangle**: 四角形（長方形）+ 角丸設定
- **サイズ設定**: 
  - 幅: 10mm〜50mm
  - 高さ: 10mm〜50mm
  - デフォルト: 20mm × 20mm（正円）
- **角丸設定**: 四角形の場合のみ、0mm〜10mm（デフォルト: 4mm）
- **将来拡張**: トゲトゲなどの装飾形状（現在は不要）

### 2. バッジ管理UI

#### 2.1 バッジマネージャーモーダル
- **アクセス**: メインページ「🏷️ カスタムバッジ管理」ボタン
- **機能**:
  - バッジ一覧表示（5個まで制限表示）
  - 新規作成・編集・削除
  - リアルタイムプレビュー
  - 作成数制限の可視化

#### 2.2 バッジ一覧表示
- **表示形式**: グリッドレイアウト（1-2列）
- **情報**:
  - バッジプレビュー（実際のサイズ）
  - バッジ名
  - タイプ（テキスト/画像）
  - 作成日時
- **操作**: 編集・削除ボタン

#### 2.3 バッジ作成・編集フォーム
- **レイアウト**: 左側フォーム、右側プレビュー
- **バリデーション**: リアルタイム入力検証
- **プレビュー**: 設定変更の即時反映

### 3. バッジ選択・適用

#### 3.1 POP作成・編集時の選択
- **場所**: CreatePopModal内
- **UI**: バッジ一覧から選択（ドロップダウンではなく一覧表示）
- **制約**: POPごとに1個のみ選択可能
- **表示**: バッジ名とプレビューを併記

#### 3.2 条件付き表示
- **表示条件**: POP作成時にバッジを指定している場合のみ表示
- **非選択時**: バッジ要素自体が非表示

### 4. 画像バッジ（将来対応）

#### 4.1 画像アップロード
- **対応形式**: JPG/PNG/WebP
- **機能**: 既存の画像アップロード機能を流用
- **トリミング**: 既存のインタラクティブトリミング機能を使用

#### 4.2 画像バッジの制約
- **色設定**: 背景色・文字色設定は無効
- **サイズ**: 可変（POPテンプレート上で調整）

### 5. レンダリング・表示

#### 5.1 CustomBadgeRenderer
- **役割**: 既存BadgeRendererを完全置き換え
- **対応**: テキスト・画像両タイプの描画
- **特徴**:
  - 円形描画
  - 文字の中央配置
  - フォントサイズの自動調整（円からはみ出し防止）

#### 5.2 ビジュアルエディタ連携
- **配置**: ドラッグ&ドロップ対応
- **リサイズ**: 8方向ハンドルでサイズ調整
- **プレビュー**: サンプルデータでの表示
- **バッジ配置設定**: 
  - **水平配置**: left（左寄せ）/ center（中央寄せ・デフォルト）/ right（右寄せ）
  - **垂直配置**: top（上寄せ）/ middle（中央寄せ・デフォルト）/ bottom（下寄せ）
  - **説明**: 要素選択エリア内におけるバッジ全体の配置位置を設定
  - **メリット**: 要素サイズとバッジサイズの違いに柔軟対応、デザインの自由度向上

## 技術仕様

### データ構造

#### CustomBadge
```typescript
interface CustomBadge {
  id: string;                    // 一意ID
  name: string;                  // バッジ名
  type: 'text' | 'image';        // バッジタイプ
  
  // 形状・サイズ設定
  shape: 'circle' | 'rectangle'; // 形状
  width: number;                 // 幅(mm)
  height: number;                // 高さ(mm)
  borderRadius?: number;         // 角丸半径(mm) - rectangleの時のみ
  
  // テキスト設定
  text?: string;                 // 表示テキスト
  backgroundColor?: string;       // 背景色
  textColor?: string;            // 文字色
  fontSize?: number;             // フォントサイズ
  
  // 枠線設定
  borderEnabled?: boolean;       // 枠線の有無
  borderColor?: string;          // 枠線の色
  borderWidth?: number;          // 枠線の太さ(mm)
  
  // バッジ配置設定（ビジュアルエディタで使用）
  badgeAlign?: 'left' | 'center' | 'right';          // 要素エリア内の水平配置
  badgeVerticalAlign?: 'top' | 'middle' | 'bottom';  // 要素エリア内の垂直配置
  
  imageSettings?: ImageSettings; // 画像設定
  createdAt: number;             // 作成日時
  updatedAt: number;             // 更新日時
}
```

#### PopResponse更新
```typescript
// 変更前
badges: BadgeResponse[];

// 変更後
customBadgeId?: string | null;
```

### データ保存

#### LocalStorage管理
- **キー**: `discogs-pop-maker-custom-badges`
- **形式**: JSON
- **構造**:
  ```typescript
  interface CustomBadgeStorage {
    badges: CustomBadge[];    // 最大5個
    version: string;          // バージョン管理
  }
  ```

#### バリデーション
- バッジ名重複チェック
- 最大作成数制限
- 文字数制限

### UI コンポーネント

#### 新規作成
- `CustomBadgeManagerModal.tsx` - メイン管理画面
- `CustomBadgeRenderer.tsx` - 描画コンポーネント
- `CustomBadgeSelector.tsx` - POP作成時の選択UI

#### 更新対象
- `CreatePopModal.tsx` - バッジ選択UI追加
- `BadgeRenderer.tsx` - CustomBadgeRendererに置き換え
- サンプルデータ - 旧バッジから新バッジへ

## 既存機能との関係

### 完全置き換え対象
- `BadgeType` 型定義
- `Badge.ts` ドメインクラス
- `BadgeRenderer.tsx` コンポーネント
- 旧バッジのサンプルデータ

### 影響範囲
- PopResponse DTO
- CreatePopRequest/UpdatePopRequest
- PopApplicationService
- visual-editor のバッジ要素

## 実装フェーズ

### Phase 1 - 基盤（完了）
- [x] 型定義作成（CustomBadge、更新されたPopResponse）
- [x] LocalStorage管理ユーティリティ作成
- [x] CustomBadgeManagerModal作成
- [x] メインページにボタン追加

### Phase 2 - 描画・選択機能
- [ ] CustomBadgeRenderer作成（円形テキスト描画）
- [ ] CreatePopModal内にバッジ選択UI追加
- [ ] 既存BadgeRenderer置き換え

### Phase 3 - データ移行・完成
- [ ] サンプルデータ更新
- [ ] 旧バッジ関連コード削除
- [ ] マイグレーション処理

### Phase 4 - 将来拡張（未定）
- [ ] 画像バッジ機能
- [ ] サーバー保存対応
- [ ] カスタム形状対応

## 制約・注意事項

### 設計制約
- LocalStorageサイズ制限（大量の画像データ注意）
- 5個制限によるユーザビリティ配慮
- 円形固定による表示制約

### 互換性
- 既存POPデータは旧バッジ情報を完全削除
- サンプルデータも新形式に移行必要
- visual-editor との整合性確保

### パフォーマンス
- LocalStorage読み書きの最適化
- 大量バッジ作成時のメモリ使用量
- プレビュー描画の軽量化

## ユーザビリティ要件

### 使いやすさ
- 直感的なバッジ作成フロー
- リアルタイムプレビューでの即座な確認
- 制限値の明確な表示

### エラーハンドリング
- バリデーションエラーの親切なメッセージ
- データ読み込み失敗時の適切な回復
- 制限超過時の明確なガイダンス

### アクセシビリティ
- カラーピッカーのキーボード操作
- スクリーンリーダー対応
- 高コントラスト表示対応

## 将来的な拡張可能性

### 高度な設定
- グラデーション背景
- 影・エフェクト
- アニメーション効果

### 共有・連携
- バッジテンプレートの共有
- 他ユーザーとのバッジ交換
- オンラインギャラリー

### 分析・統計
- 使用頻度の高いバッジ
- 人気のデザインパターン
- A/Bテスト機能

---

この要件定義により、従来の固定バッジシステムから、ユーザーの創造性を活かせる柔軟なカスタムバッジシステムへと進化させる。